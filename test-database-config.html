<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库配置测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.success {
            background: #D1F2EB;
            color: #00695C;
            border: 1px solid #4CAF50;
        }
        .status.error {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #F44336;
        }
        .status.info {
            background: #E3F2FD;
            color: #1565C0;
            border: 1px solid #2196F3;
        }
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056CC;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗄️ 数据库配置测试</h1>
        
        <div class="form-group">
            <button class="btn" onclick="testGetPages()" id="getPagesBtn">获取页面列表</button>
            <button class="btn" onclick="testCreateDatabase()" id="createDbBtn">创建数据库</button>
            <button class="btn" onclick="testConnection()" id="testConnBtn">测试连接</button>
        </div>

        <div id="status"></div>
        <div id="debug-output" class="debug-output" style="display: none;"></div>
    </div>

    <script>
        let isExtensionContext = false;
        let availablePages = [];
        
        // 检查是否在扩展环境中
        try {
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                isExtensionContext = true;
            }
        } catch (e) {
            console.log('Not in extension context');
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showDebugOutput(content) {
            const debugDiv = document.getElementById('debug-output');
            debugDiv.textContent = content;
            debugDiv.style.display = 'block';
        }

        async function testConnection() {
            const testBtn = document.getElementById('testConnBtn');
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';
            
            try {
                if (!isExtensionContext) {
                    showStatus('此工具需要在浏览器扩展环境中运行', 'error');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'NOTION_IS_CONNECTED'
                });

                showDebugOutput(`连接测试响应:\n${JSON.stringify(response, null, 2)}`);

                if (!response) {
                    showStatus('测试失败: 未收到响应', 'error');
                } else if (response.success && response.connected) {
                    showStatus('Notion 连接正常！', 'success');
                } else if (response.success && !response.connected) {
                    showStatus('Notion 未连接，请先连接您的账户', 'error');
                } else {
                    showStatus('连接测试失败: ' + (response.error || '未知错误'), 'error');
                }
            } catch (error) {
                showStatus('测试连接失败: ' + error.message, 'error');
                showDebugOutput(`错误详情:\n${error.stack}`);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '测试连接';
            }
        }

        async function testGetPages() {
            const getPagesBtn = document.getElementById('getPagesBtn');
            getPagesBtn.disabled = true;
            getPagesBtn.textContent = '获取中...';
            
            try {
                if (!isExtensionContext) {
                    showStatus('此工具需要在浏览器扩展环境中运行', 'error');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'NOTION_GET_USER_PAGES'
                });

                showDebugOutput(`页面列表响应:\n${JSON.stringify(response, null, 2)}`);

                if (!response) {
                    showStatus('获取页面失败: 未收到响应', 'error');
                } else if (response.success) {
                    availablePages = response.pages || [];
                    showStatus(`成功获取 ${availablePages.length} 个页面`, 'success');
                    
                    if (availablePages.length === 0) {
                        showStatus('没有可用的页面。请确保您的集成已被添加到至少一个 Notion 页面。', 'error');
                    }
                } else {
                    showStatus('获取页面失败: ' + (response.error || '未知错误'), 'error');
                }
            } catch (error) {
                showStatus('获取页面失败: ' + error.message, 'error');
                showDebugOutput(`错误详情:\n${error.stack}`);
            } finally {
                getPagesBtn.disabled = false;
                getPagesBtn.textContent = '获取页面列表';
            }
        }

        async function testCreateDatabase() {
            const createDbBtn = document.getElementById('createDbBtn');
            createDbBtn.disabled = true;
            createDbBtn.textContent = '创建中...';
            
            try {
                if (!isExtensionContext) {
                    showStatus('此工具需要在浏览器扩展环境中运行', 'error');
                    return;
                }

                if (availablePages.length === 0) {
                    showStatus('请先获取页面列表', 'error');
                    return;
                }

                // 显示页面选择
                const selectedPage = await showPageSelector(availablePages);
                if (!selectedPage) {
                    showStatus('已取消创建数据库', 'info');
                    return;
                }

                const databaseName = prompt('请输入数据库名称：', 'Tweet Collection Test');
                if (!databaseName) {
                    showStatus('已取消创建数据库', 'info');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'NOTION_CREATE_DATABASE',
                    parentPageId: selectedPage.id,
                    title: databaseName
                });

                showDebugOutput(`创建数据库响应:\n${JSON.stringify(response, null, 2)}`);

                if (!response) {
                    showStatus('创建数据库失败: 未收到响应', 'error');
                } else if (response.success) {
                    showStatus(`数据库 "${databaseName}" 创建成功！`, 'success');
                } else {
                    showStatus('创建数据库失败: ' + (response.error || '未知错误'), 'error');
                }
            } catch (error) {
                showStatus('创建数据库失败: ' + error.message, 'error');
                showDebugOutput(`错误详情:\n${error.stack}`);
            } finally {
                createDbBtn.disabled = false;
                createDbBtn.textContent = '创建数据库';
            }
        }

        function showPageSelector(pages) {
            return new Promise((resolve) => {
                // 创建模态对话框
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 400px;
                    width: 90%;
                    max-height: 500px;
                    overflow-y: auto;
                `;

                const title = document.createElement('h3');
                title.textContent = '选择父页面';
                title.style.marginTop = '0';

                const subtitle = document.createElement('p');
                subtitle.textContent = '请选择一个页面作为数据库的父页面：';
                subtitle.style.color = '#666';

                const pageList = document.createElement('div');
                pageList.style.cssText = `
                    margin: 15px 0;
                    max-height: 300px;
                    overflow-y: auto;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                `;

                pages.forEach(page => {
                    const pageItem = document.createElement('div');
                    pageItem.style.cssText = `
                        padding: 10px;
                        border-bottom: 1px solid #eee;
                        cursor: pointer;
                        transition: background-color 0.2s;
                    `;
                    pageItem.textContent = page.title;
                    
                    pageItem.addEventListener('mouseenter', () => {
                        pageItem.style.backgroundColor = '#f5f5f5';
                    });
                    
                    pageItem.addEventListener('mouseleave', () => {
                        pageItem.style.backgroundColor = '';
                    });
                    
                    pageItem.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(page);
                    });
                    
                    pageList.appendChild(pageItem);
                });

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                    margin-top: 15px;
                `;

                const cancelButton = document.createElement('button');
                cancelButton.textContent = '取消';
                cancelButton.className = 'btn';
                cancelButton.style.background = '#666';
                cancelButton.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(null);
                });

                buttonContainer.appendChild(cancelButton);
                dialog.appendChild(title);
                dialog.appendChild(subtitle);
                dialog.appendChild(pageList);
                dialog.appendChild(buttonContainer);
                modal.appendChild(dialog);
                document.body.appendChild(modal);

                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(null);
                    }
                });
            });
        }

        // 页面加载时的初始化
        window.onload = function() {
            if (!isExtensionContext) {
                showStatus('⚠️ 此工具需要在浏览器扩展环境中运行。请将此页面作为扩展的一部分加载。', 'error');
            } else {
                showStatus('✅ 数据库配置测试工具已就绪', 'success');
            }
        };
    </script>
</body>
</html>
