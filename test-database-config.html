<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“é…ç½®æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .status.success {
            background: #D1F2EB;
            color: #00695C;
            border: 1px solid #4CAF50;
        }
        .status.error {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #F44336;
        }
        .status.info {
            background: #E3F2FD;
            color: #1565C0;
            border: 1px solid #2196F3;
        }
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056CC;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ æ•°æ®åº“é…ç½®æµ‹è¯•</h1>
        
        <div class="form-group">
            <button class="btn" onclick="testGetPages()" id="getPagesBtn">è·å–é¡µé¢åˆ—è¡¨</button>
            <button class="btn" onclick="testCreateDatabase()" id="createDbBtn">åˆ›å»ºæ•°æ®åº“</button>
            <button class="btn" onclick="testConnection()" id="testConnBtn">æµ‹è¯•è¿æ¥</button>
        </div>

        <div id="status"></div>
        <div id="debug-output" class="debug-output" style="display: none;"></div>
    </div>

    <script>
        let isExtensionContext = false;
        let availablePages = [];
        
        // æ£€æŸ¥æ˜¯å¦åœ¨æ‰©å±•ç¯å¢ƒä¸­
        try {
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                isExtensionContext = true;
            }
        } catch (e) {
            console.log('Not in extension context');
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function showDebugOutput(content) {
            const debugDiv = document.getElementById('debug-output');
            debugDiv.textContent = content;
            debugDiv.style.display = 'block';
        }

        async function testConnection() {
            const testBtn = document.getElementById('testConnBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                if (!isExtensionContext) {
                    showStatus('æ­¤å·¥å…·éœ€è¦åœ¨æµè§ˆå™¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ', 'error');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'NOTION_IS_CONNECTED'
                });

                showDebugOutput(`è¿æ¥æµ‹è¯•å“åº”:\n${JSON.stringify(response, null, 2)}`);

                if (!response) {
                    showStatus('æµ‹è¯•å¤±è´¥: æœªæ”¶åˆ°å“åº”', 'error');
                } else if (response.success && response.connected) {
                    showStatus('Notion è¿æ¥æ­£å¸¸ï¼', 'success');
                } else if (response.success && !response.connected) {
                    showStatus('Notion æœªè¿æ¥ï¼Œè¯·å…ˆè¿æ¥æ‚¨çš„è´¦æˆ·', 'error');
                } else {
                    showStatus('è¿æ¥æµ‹è¯•å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showStatus('æµ‹è¯•è¿æ¥å¤±è´¥: ' + error.message, 'error');
                showDebugOutput(`é”™è¯¯è¯¦æƒ…:\n${error.stack}`);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }

        async function testGetPages() {
            const getPagesBtn = document.getElementById('getPagesBtn');
            getPagesBtn.disabled = true;
            getPagesBtn.textContent = 'è·å–ä¸­...';
            
            try {
                if (!isExtensionContext) {
                    showStatus('æ­¤å·¥å…·éœ€è¦åœ¨æµè§ˆå™¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ', 'error');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'NOTION_GET_USER_PAGES'
                });

                showDebugOutput(`é¡µé¢åˆ—è¡¨å“åº”:\n${JSON.stringify(response, null, 2)}`);

                if (!response) {
                    showStatus('è·å–é¡µé¢å¤±è´¥: æœªæ”¶åˆ°å“åº”', 'error');
                } else if (response.success) {
                    availablePages = response.pages || [];
                    showStatus(`æˆåŠŸè·å– ${availablePages.length} ä¸ªé¡µé¢`, 'success');
                    
                    if (availablePages.length === 0) {
                        showStatus('æ²¡æœ‰å¯ç”¨çš„é¡µé¢ã€‚è¯·ç¡®ä¿æ‚¨çš„é›†æˆå·²è¢«æ·»åŠ åˆ°è‡³å°‘ä¸€ä¸ª Notion é¡µé¢ã€‚', 'error');
                    }
                } else {
                    showStatus('è·å–é¡µé¢å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showStatus('è·å–é¡µé¢å¤±è´¥: ' + error.message, 'error');
                showDebugOutput(`é”™è¯¯è¯¦æƒ…:\n${error.stack}`);
            } finally {
                getPagesBtn.disabled = false;
                getPagesBtn.textContent = 'è·å–é¡µé¢åˆ—è¡¨';
            }
        }

        async function testCreateDatabase() {
            const createDbBtn = document.getElementById('createDbBtn');
            createDbBtn.disabled = true;
            createDbBtn.textContent = 'åˆ›å»ºä¸­...';
            
            try {
                if (!isExtensionContext) {
                    showStatus('æ­¤å·¥å…·éœ€è¦åœ¨æµè§ˆå™¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ', 'error');
                    return;
                }

                if (availablePages.length === 0) {
                    showStatus('è¯·å…ˆè·å–é¡µé¢åˆ—è¡¨', 'error');
                    return;
                }

                // æ˜¾ç¤ºé¡µé¢é€‰æ‹©
                const selectedPage = await showPageSelector(availablePages);
                if (!selectedPage) {
                    showStatus('å·²å–æ¶ˆåˆ›å»ºæ•°æ®åº“', 'info');
                    return;
                }

                const databaseName = prompt('è¯·è¾“å…¥æ•°æ®åº“åç§°ï¼š', 'Tweet Collection Test');
                if (!databaseName) {
                    showStatus('å·²å–æ¶ˆåˆ›å»ºæ•°æ®åº“', 'info');
                    return;
                }

                const response = await chrome.runtime.sendMessage({
                    type: 'NOTION_CREATE_DATABASE',
                    parentPageId: selectedPage.id,
                    title: databaseName
                });

                showDebugOutput(`åˆ›å»ºæ•°æ®åº“å“åº”:\n${JSON.stringify(response, null, 2)}`);

                if (!response) {
                    showStatus('åˆ›å»ºæ•°æ®åº“å¤±è´¥: æœªæ”¶åˆ°å“åº”', 'error');
                } else if (response.success) {
                    showStatus(`æ•°æ®åº“ "${databaseName}" åˆ›å»ºæˆåŠŸï¼`, 'success');
                } else {
                    showStatus('åˆ›å»ºæ•°æ®åº“å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showStatus('åˆ›å»ºæ•°æ®åº“å¤±è´¥: ' + error.message, 'error');
                showDebugOutput(`é”™è¯¯è¯¦æƒ…:\n${error.stack}`);
            } finally {
                createDbBtn.disabled = false;
                createDbBtn.textContent = 'åˆ›å»ºæ•°æ®åº“';
            }
        }

        function showPageSelector(pages) {
            return new Promise((resolve) => {
                // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 400px;
                    width: 90%;
                    max-height: 500px;
                    overflow-y: auto;
                `;

                const title = document.createElement('h3');
                title.textContent = 'é€‰æ‹©çˆ¶é¡µé¢';
                title.style.marginTop = '0';

                const subtitle = document.createElement('p');
                subtitle.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªé¡µé¢ä½œä¸ºæ•°æ®åº“çš„çˆ¶é¡µé¢ï¼š';
                subtitle.style.color = '#666';

                const pageList = document.createElement('div');
                pageList.style.cssText = `
                    margin: 15px 0;
                    max-height: 300px;
                    overflow-y: auto;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                `;

                pages.forEach(page => {
                    const pageItem = document.createElement('div');
                    pageItem.style.cssText = `
                        padding: 10px;
                        border-bottom: 1px solid #eee;
                        cursor: pointer;
                        transition: background-color 0.2s;
                    `;
                    pageItem.textContent = page.title;
                    
                    pageItem.addEventListener('mouseenter', () => {
                        pageItem.style.backgroundColor = '#f5f5f5';
                    });
                    
                    pageItem.addEventListener('mouseleave', () => {
                        pageItem.style.backgroundColor = '';
                    });
                    
                    pageItem.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(page);
                    });
                    
                    pageList.appendChild(pageItem);
                });

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    justify-content: flex-end;
                    gap: 10px;
                    margin-top: 15px;
                `;

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'å–æ¶ˆ';
                cancelButton.className = 'btn';
                cancelButton.style.background = '#666';
                cancelButton.addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(null);
                });

                buttonContainer.appendChild(cancelButton);
                dialog.appendChild(title);
                dialog.appendChild(subtitle);
                dialog.appendChild(pageList);
                dialog.appendChild(buttonContainer);
                modal.appendChild(dialog);
                document.body.appendChild(modal);

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(null);
                    }
                });
            });
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            if (!isExtensionContext) {
                showStatus('âš ï¸ æ­¤å·¥å…·éœ€è¦åœ¨æµè§ˆå™¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œã€‚è¯·å°†æ­¤é¡µé¢ä½œä¸ºæ‰©å±•çš„ä¸€éƒ¨åˆ†åŠ è½½ã€‚', 'error');
            } else {
                showStatus('âœ… æ•°æ®åº“é…ç½®æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
            }
        };
    </script>
</body>
</html>
