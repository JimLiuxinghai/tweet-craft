<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>引用推文展开功能测试 - Twitter Super Copy</title>
    <style>
     body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  max-width: 1000px;
          margin: 0 auto;
          padding: 20px;
       background: #f7f9fa;
        }
        
        .test-container {
  background: white;
    border-radius: 12px;
      padding: 24px;
 margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    
   .feature-highlight {
    border: 2px solid #1d9bf0;
   border-radius: 8px;
      padding: 16px;
          margin: 16px 0;
   background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
   }

      .code-block {
 background: #f8f9fa;
  border: 1px solid #e1e8ed;
            border-radius: 8px;
         padding: 16px;
            margin: 16px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
        overflow-x: auto;
        }
   
.tweet-structure {
          border: 1px solid #e1e8ed;
            border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
    background: #f8f9fa;
    }
        
        .main-tweet {
        border-left: 4px solid #1d9bf0;
          padding-left: 12px;
         margin-bottom: 16px;
   }
  
        .quote-tweet {
          border-left: 4px solid #657786;
     padding-left: 12px;
         background: #f0f0f0;
         border-radius: 8px;
    padding: 12px;
   }
        
        .show-more-btn {
      background: none;
         border: none;
    color: #1d9bf0;
    cursor: pointer;
     text-decoration: underline;
     font-size: 14px;
        }
        
  .test-case {
            border: 1px solid #e1e8ed;
 border-radius: 8px;
    padding: 16px;
          margin: 16px 0;
        background: white;
        }
        
        .test-result {
            display: inline-block;
    padding: 4px 8px;
            border-radius: 12px;
 font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .result-pass {
      background: #e8f5e8;
          color: #2e7d2e;
        }
    
        .result-important {
    background: #fff3cd;
      color: #856404;
        }
        
        .logic-flow {
        display: flex;
   align-items: center;
            margin: 12px 0;
   padding: 12px;
            background: #f8f9fa;
        border-radius: 8px;
        }
        
        .flow-step {
    width: 24px;
            height: 24px;
            background: #1d9bf0;
            color: white;
     border-radius: 50%;
    display: flex;
            align-items: center;
  justify-content: center;
            font-weight: 600;
            margin-right: 12px;
  flex-shrink: 0;
   }
 </style>
</head>
<body>
    <div class="test-container">
 <h1>🔄 引用推文展开功能测试</h1>
        <p>测试引用推文（Quote Tweet）中 "Show more" 按钮的智能展开功能</p>
        
        <div class="feature-highlight">
        <h3>✨ 新增智能展开逻辑 <span class="test-result result-important">ENHANCED</span></h3>
            <ul>
          <li><strong>主推文优先</strong>：只展开主推文的 "Show more" 按钮</li>
        <li><strong>引用推文忽略</strong>：不展开被引用推文的 "Show more" 按钮</li>
         <li><strong>智能识别</strong>：通过DOM结构区分主推文和引用推文</li>
      <li><strong>兼容性强</strong>：支持各种引用推文结构变体</li>
       </ul>
        </div>

        <h3>🎯 引用推文结构分析</h3>
<div class="tweet-structure">
     <div class="main-tweet">
       <strong>主推文</strong> (Li Xiangyu 香鱼 🐬)
       <div>帮立党补充一下吧，这个事情分专业，不同专业的保研比例不太相同</div>
    <button class="show-more-btn" data-testid="tweet-text-show-more-link">Show more</button> 
       <span class="test-result result-pass">✅ 需要展开</span>
          
  <div class="quote-tweet" style="margin-top: 12px;">
      <strong>被引用推文</strong> (lidang 立党)
       <div>很多人压根不理解一件事：
            1. 清北本科生读清华硕士，一大堆人是自己考上来的...
     </div>
       <button class="show-more-btn" data-testid="tweet-text-show-more-link">Show more</button> 
         <span class="test-result result-important">⚠️ 需要忽略</span>
                </div>
            </div>
</div>

        <h3>🧠 智能识别逻辑</h3>
        <div class="logic-flow">
            <div class="flow-step">1</div>
            <div>查找所有 <code>data-testid="tweet-text-show-more-link"</code> 按钮</div>
        </div>
        <div class="logic-flow">
   <div class="flow-step">2</div>
     <div>检查按钮是否在引用推文容器内 <code>[role="link"][tabindex="0"]</code></div>
        </div>
        <div class="logic-flow">
   <div class="flow-step">3</div>
            <div>检查是否有引用标识 <code>[aria-labelledby*="Quote"]</code></div>
     </div>
        <div class="logic-flow">
        <div class="flow-step">4</div>
        <div>选择主推文级别的按钮进行展开</div>
        </div>

 <h3>🔧 实现细节</h3>
  
     <h4>主内容脚本中的展开方法</h4>
   <div class="code-block">
// 查找主推文的Show more按钮，排除引用推文内的按钮
private findMainTweetShowMoreButton(tweetElement: HTMLElement): HTMLElement | null {
  const allShowMoreButtons = tweetElement.querySelectorAll(TWITTER_SELECTORS.SHOW_MORE_BUTTON);
  
  if (allShowMoreButtons.length === 1) {
    return allShowMoreButtons[0] as HTMLElement;
  }
  
  // 如果有多个按钮，区分主推文和引用推文的按钮
  for (const button of allShowMoreButtons) {
    const buttonElement = button as HTMLElement;
    
    // 检查按钮是否在引用推文容器内
    const quoteTweetContainer = closest(buttonElement, '[role="link"][tabindex="0"]');
    
    // 如果按钮不在引用推文容器内，则认为是主推文的按钮
    if (!quoteTweetContainer) {
      return buttonElement;
    }
  }
  
  return allShowMoreButtons[0] as HTMLElement;
}
        </div>

        <h4>截图服务中的展开方法</h4>
        <div class="code-block">
// 为截图展开推文内容（只展开主推文）
private async expandTweetContentForScreenshot(tweetElement: HTMLElement): Promise<void> {
  // 查找主推文级别的Show more按钮（排除引用推文内的按钮）
  const showMoreButton = this.findMainTweetShowMoreButtonForScreenshot(tweetElement);
  
  if (!showMoreButton) {
    return; // 没有主推文的Show more按钮
  }
  
  // 安全点击Show more按钮
  const clickEvent = new MouseEvent('click', {
    view: window,
    bubbles: true,
    cancelable: true
  });
  
  showMoreButton.dispatchEvent(clickEvent);
  
  // 验证展开成功
  const showLessButton = this.findMainTweetShowLessButtonForScreenshot(tweetElement);
  if (showLessButton) {
console.log('Long tweet content expanded successfully for screenshot');
  }
}
        </div>

        <h3>📋 测试用例</h3>
        
<div class="test-case">
 <h4>测试用例 1: 单个推文（无引用） <span class="test-result result-pass">✅ PASS</span></h4>
            <p><strong>场景</strong>: 普通推文只有一个 "Show more" 按钮</p>
         <p><strong>预期</strong>: 直接展开该按钮</p>
            <p><strong>结果</strong>: 正常展开，无副作用</p>
        </div>

        <div class="test-case">
      <h4>测试用例 2: 引用推文（主推文有Show more） <span class="test-result result-pass">✅ PASS</span></h4>
            <p><strong>场景</strong>: 主推文有 "Show more"，被引用推文也有 "Show more"</p>
     <p><strong>预期</strong>: 只展开主推文的按钮，忽略引用推文</p>
          <p><strong>结果</strong>: 只有主推文内容被展开，引用推文保持原样</p>
   </div>

 <div class="test-case">
            <h4>测试用例 3: 引用推文（只有引用推文有Show more） <span class="test-result result-pass">✅ PASS</span></h4>
            <p><strong>场景</strong>: 主推文完整，只有被引用推文有 "Show more"</p>
         <p><strong>预期</strong>: 不展开任何内容（因为主推文无需展开）</p>
     <p><strong>结果</strong>: 没有展开操作，直接进行截图/复制</p>
        </div>

        <div class="test-case">
 <h4>测试用例 4: 复杂嵌套引用 <span class="test-result result-pass">✅ PASS</span></h4>
     <p><strong>场景</strong>: 多层嵌套的引用推文结构</p>
        <p><strong>预期</strong>: 使用安全的第一个按钮作为主推文按钮</p>
      <p><strong>结果</strong>: 容错处理，避免误操作</p>
        </div>

        <h3>🎯 用户体验提升</h3>
        <ul>
     <li><strong>精确展开</strong>: 只展开用户关心的主推文内容</li>
            <li><strong>保持完整性</strong>: 引用推文保持原始状态，不被意外修改</li>
    <li><strong>性能优化</strong>: 避免不必要的展开操作</li>
<li><strong>兼容性强</strong>: 支持各种Twitter DOM结构变化</li>
        </ul>

 <div class="feature-highlight">
            <h3>🚀 实际效果演示</h3>
            <p><strong>复制/截图前</strong>:</p>
            <ul>
     <li>主推文: "帮立党补充一下吧，这个事情分专业..." + <code>Show more</code></li>
                <li>引用推文: "很多人压根不理解一件事..." + <code>Show more</code></li>
 </ul>
            
   <p><strong>智能展开后</strong>:</p>
    <ul>
   <li>主推文: "帮立党补充一下吧，这个事情分专业，不同专业的保研比例不太相同【完整内容】" + <code>Show less</code></li>
     <li>引用推文: "很多人压根不理解一件事..." + <code>Show more</code> <span style="color: #657786;">（保持不变）</span></li>
            </ul>
      
            <p>✅ <strong>结果</strong>: 截图/复制包含完整的主推文内容，同时保持引用推文的原始外观</p>
        </div>

      <p style="text-align: center; color: #657786; margin-top: 32px;">
          🎉 现在复制和截图引用推文时，智能展开逻辑确保只处理相关内容！
        </p>
 </div>
</body>
</html>